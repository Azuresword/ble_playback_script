# BLE 数据处理 Web 应用 - 技术架构

## 🎯 架构概览

```
┌─────────────────────────────────────────────────────────┐
│                    用户浏览器                            │
│                http://localhost:3000                    │
└──────────────────┬──────────────────────────────────────┘
                   │
                   │ HTTP/WebSocket
                   │
┌──────────────────▼──────────────────────────────────────┐
│               Vue 3 前端应用                             │
│  ┌─────────────────────────────────────────────────┐   │
│  │  组件层                                          │   │
│  │  • 上传组件 (Element Upload)                    │   │
│  │  • 处理进度 (Progress Bar)                      │   │
│  │  • 文件列表 (Table)                             │   │
│  │  • 图表可视化 (ECharts)                         │   │
│  └─────────────────────────────────────────────────┘   │
│  ┌─────────────────────────────────────────────────┐   │
│  │  状态管理                                        │   │
│  │  • uploadedFile, files, taskStatus              │   │
│  └─────────────────────────────────────────────────┘   │
│  ┌─────────────────────────────────────────────────┐   │
│  │  HTTP 客户端 (Axios)                            │   │
│  └─────────────────────────────────────────────────┘   │
└──────────────────┬──────────────────────────────────────┘
                   │
                   │ API 请求 (JSON)
                   │
┌──────────────────▼──────────────────────────────────────┐
│            FastAPI 后端服务                              │
│                http://localhost:8000                    │
│  ┌─────────────────────────────────────────────────┐   │
│  │  路由层                                          │   │
│  │  POST /api/upload        - 文件上传             │   │
│  │  POST /api/process       - 启动处理任务         │   │
│  │  GET  /api/task/{id}     - 查询任务状态         │   │
│  │  GET  /api/files         - 文件列表             │   │
│  │  GET  /api/download/...  - 文件下载             │   │
│  │  GET  /api/preview/...   - CSV 预览             │   │
│  │  GET  /api/stats/...     - 数据统计             │   │
│  └─────────────────────────────────────────────────┘   │
│  ┌─────────────────────────────────────────────────┐   │
│  │  业务逻辑层                                      │   │
│  │  • 后台任务调度 (BackgroundTasks)               │   │
│  │  • 任务状态管理 (tasks_status 字典)             │   │
│  │  • 文件操作 (aiofiles)                          │   │
│  └─────────────────────────────────────────────────┘   │
└──────────────────┬──────────────────────────────────────┘
                   │
                   │ subprocess.run()
                   │
┌──────────────────▼──────────────────────────────────────┐
│              Python 数据处理脚本                         │
│  • split_by_device.py    - 设备数据拆分                │
│  • align_barometer.py    - 气压计对齐                   │
│  • downsample_50hz.py    - 50Hz 降采样                  │
│  • csv_to_bin.py         - 二进制转换                   │
└──────────────────┬──────────────────────────────────────┘
                   │
                   │ 读写文件
                   │
┌──────────────────▼──────────────────────────────────────┐
│                  文件系统                                │
│  uploads/          - 上传的文件                         │
│  WTR1_data/        - 右腕设备数据                       │
│  WTL1_data/        - 左腕设备数据                       │
│  WTB1_data/        - 腰部设备数据                       │
│  bmp/              - 气压计数据                         │
└─────────────────────────────────────────────────────────┘
```

## 🔧 技术选型理由

### 后端：FastAPI

**为什么选择 FastAPI？**
1. ✅ **原生 Python** - 可直接复用现有的数据处理脚本
2. ✅ **异步支持** - 高性能的异步 I/O，适合文件上传下载
3. ✅ **自动文档** - 自动生成 Swagger UI (http://localhost:8000/docs)
4. ✅ **类型提示** - Pydantic 模型，类型安全
5. ✅ **现代化** - ASGI 标准，比传统 Flask 性能更好

**核心依赖**：
```python
fastapi==0.109.0          # Web 框架
uvicorn[standard]==0.27.0 # ASGI 服务器
python-multipart==0.0.6   # 文件上传支持
aiofiles==23.2.1          # 异步文件操作
pandas==2.1.4             # 数据分析
```

### 前端：Vue 3 + Vite

**为什么选择 Vue 3？**
1. ✅ **渐进式** - 可以从简单开始，逐步增加复杂度
2. ✅ **组合式 API** - `<script setup>` 语法简洁直观
3. ✅ **响应式系统** - 高效的数据绑定
4. ✅ **生态完善** - Element Plus、ECharts 集成良好
5. ✅ **中文文档** - 对中文用户友好

**为什么选择 Vite？**
1. ✅ **极速启动** - 开发服务器秒启动
2. ✅ **热更新** - HMR 更新速度快
3. ✅ **现代化** - 原生 ES 模块
4. ✅ **简单配置** - 零配置即可使用

**为什么选择 Element Plus？**
1. ✅ **Vue 3 专属** - 完全支持 Composition API
2. ✅ **组件丰富** - Upload、Table、Progress、Dialog 等
3. ✅ **美观现代** - 设计规范统一
4. ✅ **中文文档** - 降低学习成本

**为什么选择 ECharts？**
1. ✅ **功能强大** - 支持各种复杂图表
2. ✅ **交互性强** - 缩放、拖拽、数据点查看
3. ✅ **性能优秀** - 大数据量渲染流畅
4. ✅ **社区活跃** - 文档和示例丰富

## 📊 数据流程

### 1. 文件上传流程

```
用户选择文件
    ↓
前端: Element Upload 组件触发
    ↓
HTTP POST /api/upload (multipart/form-data)
    ↓
后端: 保存到 uploads/ 目录
    ↓
后端: 读取前 10 行预览
    ↓
返回: { filename, size, preview }
    ↓
前端: 显示文件信息和预览表格
```

### 2. 数据处理流程

```
用户点击"开始处理"
    ↓
前端: HTTP POST /api/process
  Body: { filename, steps: [...] }
    ↓
后端: 创建任务 ID
    ↓
后端: BackgroundTasks 异步执行
    ↓
┌─────────────────────────────┐
│  后台任务执行                │
│  1. 复制文件到工作目录        │
│  2. 依次执行 Python 脚本      │
│     - split_by_device.py    │
│     - align_barometer.py    │
│     - downsample_50hz.py    │
│     - csv_to_bin.py         │
│  3. 更新任务状态和进度        │
└─────────────────────────────┘
    ↓
前端: 轮询 GET /api/task/{id} (每秒)
    ↓
前端: 更新进度条和状态消息
    ↓
任务完成: 显示结果文件列表
```

### 3. 数据可视化流程

```
用户点击"图表"按钮
    ↓
前端: HTTP GET /api/stats/{device}/{filename}
    ↓
后端: Pandas 读取 CSV
    ↓
后端: 计算统计信息 (min, max, mean, std)
    ↓
返回: { row_count, column_count, numeric_stats }
    ↓
前端: HTTP GET /api/preview/{device}/{filename}?limit=1000
    ↓
后端: 返回前 1000 行数据
    ↓
前端: ECharts 绘制折线图
  • X 轴: 采样点索引
  • Y 轴: 传感器数值
  • 系列: AccX, AccY, AccZ
  • 支持: 缩放、拖拽
```

## 🎨 UI/UX 设计

### 布局结构

```
┌─────────────────────────────────────────────────┐
│  Header (渐变紫色背景)                           │
│  🔗 BLE 数据处理平台                 v1.0.0     │
└─────────────────────────────────────────────────┘
┌──────────┬──────────────────────────────────────┐
│          │                                      │
│ Sidebar  │        Main Content Area            │
│          │                                      │
│ • 上传   │   ┌────────────────────────────┐    │
│ • 处理   │   │                            │    │
│ • 文件   │   │    根据选中的菜单项         │    │
│ • 可视化 │   │    动态显示不同内容         │    │
│          │   │                            │    │
│          │   └────────────────────────────┘    │
│          │                                      │
└──────────┴──────────────────────────────────────┘
```

### 颜色方案

- **主色调**: `#667eea` → `#764ba2` (渐变紫)
- **成功**: `#67C23A` (绿色)
- **警告**: `#E6A23C` (黄色)
- **危险**: `#F56C6C` (红色)
- **信息**: `#409EFF` (蓝色)
- **背景**: `#f5f7fa` (浅灰)

### 交互设计

1. **拖拽上传** - 直观的文件拖拽区域
2. **实时反馈** - 处理进度实时更新
3. **状态指示** - 颜色编码的状态消息
4. **加载动画** - Loading 状态的按钮动画
5. **响应式** - 适配不同屏幕尺寸

## 🚀 性能优化

### 后端优化

1. **异步处理** - 使用 `BackgroundTasks` 避免阻塞
2. **流式传输** - 大文件下载使用 `FileResponse`
3. **数据采样** - 预览和图表限制数据量（默认 1000 行）
4. **缓存策略** - 任务状态存储在内存中快速访问

### 前端优化

1. **按需加载** - Vue 3 的 Tree-shaking
2. **图表优化** - ECharts 数据抽样和渲染优化
3. **防抖节流** - 避免频繁 API 调用
4. **虚拟滚动** - 大数据表格使用虚拟滚动

## 🔐 安全考虑

1. **CORS 配置** - 允许跨域访问（开发环境）
2. **文件类型验证** - 只允许 .csv 和 .txt
3. **路径安全** - 使用 `Path` 对象防止路径遍历
4. **错误处理** - 统一的异常捕获和用户友好的错误提示

## 📦 部署建议

### 开发环境（当前）

```bash
./start_web.sh
```

- 前端: Vite 开发服务器 (端口 3000)
- 后端: Uvicorn 开发服务器 (端口 8000)

### 生产环境

1. **前端构建**:
```bash
cd web
npm run build
# 生成 dist/ 目录
```

2. **后端部署**:
```bash
# 使用 Gunicorn + Uvicorn Workers
gunicorn app:app -w 4 -k uvicorn.workers.UvicornWorker
```

3. **Nginx 反向代理**:
```nginx
server {
    listen 80;

    location / {
        root /path/to/web/dist;
        try_files $uri $uri/ /index.html;
    }

    location /api {
        proxy_pass http://127.0.0.1:8000;
    }
}
```

## 🎯 扩展方向

1. **用户认证** - 添加登录系统
2. **多文件上传** - 批量处理多个数据集
3. **实时日志** - WebSocket 实时推送处理日志
4. **数据对比** - 多个数据集的对比分析
5. **导出报告** - 生成 PDF/Excel 分析报告
6. **Docker 化** - 容器化部署
7. **数据库集成** - 存储历史处理记录

## 📚 参考资源

- [FastAPI 官方文档](https://fastapi.tiangolo.com/)
- [Vue 3 官方文档](https://cn.vuejs.org/)
- [Element Plus 文档](https://element-plus.org/)
- [ECharts 文档](https://echarts.apache.org/)
- [Vite 文档](https://vitejs.dev/)
